<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Song Writer AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-md mx-auto bg-white rounded-xl shadow-md overflow-hidden md:max-w-2xl">
        <div class="p-8">
            <h1 class="text-2xl font-bold mb-4">üéµ Song Writer AI ü§ñ</h1>
            
            <div id="initialForm">
                <input type="text" id="themeInput" placeholder="Enter a theme for your song" class="w-full p-2 border rounded mb-4">
                <button id="generateButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Write Initial Draft</button>
            </div>
            
            <div id="refinementForm" class="hidden">
                <input type="text" id="lyricsRefinement" placeholder="Lyrics refinement (e.g., Make it more upbeat)" class="w-full p-2 border rounded mb-4">
                <input type="text" id="melodyAdjustment" placeholder="Melody adjustment (e.g., Add more rhythm)" class="w-full p-2 border rounded mb-4">
                <button id="refineButton" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Refine Song</button>
            </div>
            
            <div id="output" class="mt-4"></div>
        </div>
    </div>

    <script>
        const initialForm = document.getElementById('initialForm');
        const refinementForm = document.getElementById('refinementForm');
        const generateButton = document.getElementById('generateButton');
        const refineButton = document.getElementById('refineButton');
        const themeInput = document.getElementById('themeInput');
        const lyricsRefinement = document.getElementById('lyricsRefinement');
        const melodyAdjustment = document.getElementById('melodyAdjustment');
        const output = document.getElementById('output');

        let refinementCount = 0;

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Copied to clipboard!');
            }, (err) => {
                console.error('Could not copy text: ', err);
            });
        }

        function addDraftToOutput(title, lyrics, melody) {
            const draftElement = document.createElement('div');
            draftElement.className = 'p-4 bg-gray-100 rounded mb-4';
            draftElement.innerHTML = `
                <h3 class="font-bold">${title}:</h3>
                <div class="mt-2">
                    <strong>üìù Lyrics:</strong>
                    <button class="ml-2 px-2 py-1 bg-blue-500 text-white rounded text-sm" onclick="copyToClipboard(this.nextElementSibling.textContent)">Copy Lyrics</button>
                    <pre class="whitespace-pre-wrap mt-1">${lyrics || 'No lyrics generated'}</pre>
                </div>
                <div class="mt-2">
                    <strong>üéµ Melody:</strong>
                    <button class="ml-2 px-2 py-1 bg-blue-500 text-white rounded text-sm" onclick="copyToClipboard(this.nextElementSibling.textContent)">Copy Melody</button>
                    <pre class="whitespace-pre-wrap mt-1">${melody || 'No melody generated'}</pre>
                </div>
            `;
            output.insertBefore(draftElement, output.firstChild);
        }

        generateButton.addEventListener('click', async () => {
            const theme = themeInput.value;
            
            const loadingElement = document.createElement('div');
            loadingElement.textContent = `üé® Starting to write a song about "${theme}"...`;
            output.insertBefore(loadingElement, output.firstChild);

            try {
                const response = await fetch('/write_initial_draft', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ theme }),
                });

                if (!response.ok) {
                    throw new Error('Something went wrong');
                }

                const data = await response.json();

                output.removeChild(loadingElement);
                addDraftToOutput('Initial Draft', data.lyrics, data.melody);

                initialForm.classList.add('hidden');
                refinementForm.classList.remove('hidden');
            } catch (error) {
                output.removeChild(loadingElement);
                const errorElement = document.createElement('p');
                errorElement.className = 'text-red-500';
                errorElement.textContent = `Oops! Something went wrong: ${error.message}`;
                output.insertBefore(errorElement, output.firstChild);
            }
        });

        refineButton.addEventListener('click', async () => {
            const theme = themeInput.value;
            const lyricsRefine = lyricsRefinement.value || "Make it more upbeat";
            const melodyAdjust = melodyAdjustment.value || "Add more rhythm";
            
            refinementCount++;

            const loadingElement = document.createElement('div');
            loadingElement.textContent = `üîÑ Refining the song (Refinement #${refinementCount})...`;
            output.insertBefore(loadingElement, output.firstChild);

            try {
                const response = await fetch('/refine_song', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ theme, lyricsRefine, melodyAdjust }),
                });

                if (!response.ok) {
                    throw new Error('Something went wrong');
                }

                const data = await response.json();

                output.removeChild(loadingElement);
                addDraftToOutput(`Refinement #${refinementCount}`, data.lyrics, data.melody);

                // Clear refinement inputs for next iteration
                lyricsRefinement.value = '';
                melodyAdjustment.value = '';
            } catch (error) {
                output.removeChild(loadingElement);
                const errorElement = document.createElement('p');
                errorElement.className = 'text-red-500';
                errorElement.textContent = `Oops! Something went wrong: ${error.message}`;
                output.insertBefore(errorElement, output.firstChild);
            }
        });
    </script>
</body>
</html>